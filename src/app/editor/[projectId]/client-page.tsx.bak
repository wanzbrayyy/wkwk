"use client"

import {
  ArrowLeft, Play, Save, Download, FileCode2,
  Settings, Bot, Search, Plus, X, Code2, PanelLeftClose, PanelRightClose
} from "lucide-react"
import Link from "next/link"
import { ChatInterface } from "@/components/chat/chat-interface"
import { Message } from "ai"
import { Project, File, Message as PrismaMessage } from "@prisma/client"
import { useRouter } from "next/navigation"
import { useEditorStore, FileNode } from "@/hooks/use-editor-store" // <-- PERBAIKAN DI SINI: Tambahkan FileNode
import { useCodeGeneration } from "@/hooks/use-code-generation"
import { FileExplorer } from "@/components/editor/file-explorer"
import { CodeView } from "@/components/editor/code-view"
import { Terminal } from "@/components/editor/terminal"
import { PreviewPane } from "@/components/editor/preview-pane"
import { toast } from "sonner"
import { useEffect, useState } from "react"
import { mapPrismaRoleToAiRole } from "@/lib/parser"

interface ProjectWithDetails extends Project {
  files: File[];
  messages: PrismaMessage[];
}

interface ClientEditorPageProps {
  projectData: string
}

export function ClientEditorPage({ projectData }: ClientEditorPageProps) {
  const project: ProjectWithDetails = JSON.parse(projectData)
  const router = useRouter()

  const {
    files,
    activeFileId,
    openFiles,
    fileContents,
    setFiles,
    setActiveFile,
    openFile,
    closeFile,
    updateFileContent,
    getFileContent,
  } = useEditorStore()

  const initialMessages: Message[] = project.messages
    .filter(msg => ["user", "assistant", "system"].includes(msg.role))
    .map(msg => ({
      id: msg.id,
      role: mapPrismaRoleToAiRole(msg.role),
      content: msg.content,
    })) as Message[]

  const {
    messages,
    input,
    handleInputChange,
    handleSubmit,
    isLoading,
  } = useCodeGeneration({
    projectId: project.id,
    initialMessages: initialMessages
  })

  const [showExplorer, setShowExplorer] = useState(true)
  const [showChat, setShowChat] = useState(true)
  const [showPreview, setShowPreview] = useState(false)

  // Initialize editor store with project files from server
  useEffect(() => {
    if (project && project.files.length > 0 && files.length === 0) {
      const initialFileNodes = project.files.map(f => ({
        id: f.id,
        name: f.name,
        type: "file",
        path: f.path,
        content: f.content,
        language: f.language,
      }));

      const buildFileTree = (flatFiles: typeof initialFileNodes): FileNode[] => {
        const tree: FileNode[] = [];
        const pathMap: { [key: string]: FileNode } = {};

        flatFiles.forEach(file => {
          const parts = file.path.split('/');
          let currentPath = '';
          let currentNode: FileNode[] = tree;

          parts.forEach((part, index) => {
            currentPath = currentPath ? `${currentPath}/${part}` : part;
            const isFile = index === parts.length - 1;

            if (!pathMap[currentPath]) {
              const newNode: FileNode = {
                id: isFile ? file.id : Math.random().toString(36).substring(2, 9),
                name: part,
                type: isFile ? "file" : "folder",
                path: currentPath,
                children: isFile ? undefined : [],
                content: isFile ? file.content : undefined,
                language: isFile ? file.language : undefined,
              };
              currentNode.push(newNode);
              pathMap[currentPath] = newNode;
            }

            if (!isFile) {
              currentNode = pathMap[currentPath].children!;
            }
          });
        });

        tree.sort((a, b) => {
          if (a.type === "folder" && b.type === "file") return -1;
          if (a.type === "file" && b.type === "folder") return 1;
          return a.name.localeCompare(b.name);
        });

        return tree;
      };

      setFiles(buildFileTree(initialFileNodes));
      if (project.files.length > 0) {
        openFile(project.files[0].path, project.files[0].content);
        setActiveFile(project.files[0].path);
      }
    }
  }, [project, files.length, setFiles, openFile, setActiveFile]);

  const handleSaveFile = async () => {
    if (!activeFileId) {
      toast.info("No active file to save.");
      return;
    }
    const contentToSave = getFileContent(activeFileId);
    if (contentToSave === undefined) {
      toast.error("File content not found.");
      return;
    }

    try {
      const response = await fetch("/api/files", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          projectId: project.id,
          path: activeFileId,
          content: contentToSave,
          language: files.find(f => f.path === activeFileId)?.language || "plaintext"
        }),
      });

      if (!response.ok) {
        throw new Error("Failed to save file.");
      }
      toast.success(`File '${activeFileId}' saved!`);
    } catch (error: any) {
      toast.error(error.message || "Error saving file.");
    }
  };

  const handleRunProject = () => {
    setShowPreview(true);
    toast.info("Project run initiated (showing preview).");
  };

  const handleSelectFile = (path: string) => {
    const fileNode = project.files.find(f => f.path === path);
    if (fileNode) {
      openFile(fileNode.path, fileNode.content);
      setActiveFile(fileNode.path);
    } else {
      const content = getFileContent(path);
      openFile(path, content);
      setActiveFile(path);
    }
  };

  return (
    <div className="flex flex-col h-full bg-[#1e1e1e]">
      <header className="h-14 border-b border-[#333] bg-[#1e1e1e] flex items-center justify-between px-4 shrink-0">
        <div className="flex items-center gap-4">
          <Link href="/dashboard" className="p-2 hover:bg-[#2d2d2d] rounded-md transition-colors text-[#708F96]">
            <ArrowLeft className="h-5 w-5" />
          </Link>
          <div className="flex flex-col sm:flex-row sm:items-center sm:gap-3">
            <div className="h-8 w-8 rounded bg-gradient-brand flex items-center justify-center">
               <span className="font-bold text-white text-xs">AC</span>
            </div>
            <span className="text-sm font-medium text-[#e0e0e0]">{project.name}</span>
            <span className="text-[10px] text-[#AA895F] hidden sm:block">Editing mode</span>
          </div>
        </div>
        
        <div className="flex items-center gap-2">
          <div className="hidden sm:flex items-center bg-[#252526] rounded-md border border-[#333] px-2 py-1 mr-4">
            <div className="w-2 h-2 rounded-full bg-[#AA895F] animate-pulse mr-2"></div>
            <span className="text-xs text-muted-foreground">AI Ready</span>
          </div>

          <button
            className="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-[#e0e0e0] hover:bg-[#2d2d2d] rounded-md transition-colors border border-[#333]"
            onClick={handleSaveFile}
          >
            <Save className="h-3.5 w-3.5" />
            Save
          </button>
          <button
            className="flex items-center gap-2 px-3 py-1.5 text-xs font-medium bg-gradient-brand text-white hover:opacity-90 rounded-md transition-all shadow-lg shadow-[#708F96]/10"
            onClick={handleRunProject}
          >
            <Play className="h-3.5 w-3.5 fill-current" />
            Run Project
          </button>
          <button className="p-2 text-[#708F96] hover:bg-[#2d2d2d] rounded-md transition-colors hidden md:block">
            <Settings className="h-4 w-4" />
          </button>
        </div>
      </header>

      <div className="flex-1 flex overflow-hidden">
        <button
          className="absolute left-0 top-1/2 -translate-y-1/2 bg-[#252526] text-[#e0e0e0] p-1.5 rounded-r-md z-20 md:hidden border-r border-t border-b border-[#333]"
          onClick={() => setShowExplorer(!showExplorer)}
        >
          {showExplorer ? <PanelLeftClose className="h-4 w-4" /> : <PanelRightClose className="h-4 w-4 rotate-180" />}
        </button>

        <aside className={`${showExplorer ? 'translate-x-0' : '-translate-x-full'} absolute md:relative inset-y-0 left-0 w-64 md:w-64 border-r border-[#333] bg-[#252526] flex flex-col z-10 transition-transform duration-200 ease-in-out`}>
          <FileExplorer
            files={files}
            activeFileId={activeFileId}
            onSelectFile={handleSelectFile}
          />
        </aside>

        <main className="flex-1 flex flex-col bg-[#1e1e1e] relative min-w-0">
          <CodeView
            files={openFiles.map(path => ({
              path,
              content: getFileContent(path),
              language: files.find(f => f.path === path)?.language || "plaintext"
            }))}
            activeFile={activeFileId}
            onCloseFile={(path) => closeFile(path)}
            onSelectFile={handleSelectFile}
            onCodeChange={(content) => {
              if (activeFileId) updateFileContent(activeFileId, content);
            }}
          />
          <Terminal />
        </main>

        <div className="absolute right-0 top-1/2 -translate-y-1/2 flex flex-col gap-2 z-20 md:hidden">
          <button
            className="bg-[#252526] text-[#e0e0e0] p-1.5 rounded-l-md border-l border-t border-b border-[#333]"
            onClick={() => { setShowChat(!showChat); setShowPreview(false); }}
          >
            {showChat ? <PanelRightClose className="h-4 w-4" /> : <PanelLeftClose className="h-4 w-4 rotate-180" />}
          </button>
          <button
            className="bg-[#252526] text-[#e0e0e0] p-1.5 rounded-l-md border-l border-t border-b border-[#333]"
            onClick={() => { setShowPreview(!showPreview); setShowChat(false); }}
          >
            {showPreview ? <PanelRightClose className="h-4 w-4" /> : <Play className="h-4 w-4" />}
          </button>
        </div>


        {(showChat || showPreview) && (
          <div className="absolute md:relative inset-y-0 right-0 w-full md:w-80 flex-shrink-0 z-10 bg-[#1e1e1e] transition-transform duration-200 ease-in-out">
            {showPreview ? (
              <PreviewPane />
            ) : (
              <ChatInterface
                messages={messages}
                input={input}
                handleInputChange={handleInputChange}
                onSubmit={handleSubmit}
                isLoading={isLoading}
              />
            )}
          </div>
        )}
      </div>

      <div className="h-6 bg-[#708F96] text-white flex items-center justify-between px-3 text-xs select-none shrink-0">
        <div className="flex items-center gap-3">
           <span className="font-bold">main*</span>
           <span>0 errors</span>
        </div>
        <div className="flex items-center gap-3">
           <button onClick={() => setShowPreview(!showPreview)} className="hover:text-[#e0e0e0] flex items-center gap-1">
             {showPreview ? <PanelRightClose className="h-3 w-3" /> : <Play className="h-3 w-3" />}
             {showPreview ? "Hide Preview" : "Show Preview"}
           </button>
           <span>TypeScript React</span>
        </div>
      </div>
    </div>
  )
}